name: deploy
env:
  VERSION: "0.0.1-r${{ github.sha }}"

permissions:
  id-token: write
  packages: write
  contents: read
  pull-requests: read

on:
  workflow_call:
    secrets:
      GCR_READ_JSON_KEY:
        required: true
      GH_PACKAGE_USERNAME:
        required: true
      GH_PACKAGE_TOKEN:
        required: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:

    - name: Set up Go
      uses: actions/setup-go@v1
      with:
        go-version: 1.18
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Run test
      run: make test

    - name: Test Docker build
      run: docker build --rm -t ghcr.io/tink-ab/objinsync:latest .


  docker-build:
    name: Build Docker image
    needs:
      - gradle-checks
    runs-on: ubuntu-latest
    steps:
      - name: Run Docker build action
        uses: tink-ab/reusable-workflows/.github/actions/tink-docker-build-action@master
        with:
          version: ${{ env.VERSION }}
          repository: ${{ github.repository }}
          repository-owner: ${{ github.repository_owner }}
          gcr-read-json-key: ${{ secrets.GCR_READ_JSON_KEY }}
          gh-token: ${{ secrets.GITHUB_TOKEN }}
          gh-package-username-read-permission: ${{ secrets.GH_PACKAGE_USERNAME }}
          gh-package-token-read-permission: ${{ secrets.GH_PACKAGE_TOKEN }}
          push-build-image-to-ghcr: true
